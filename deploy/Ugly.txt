<!DOCTYPE html>
<html>
<head>
    <title>Portfolio Task Burn Up/Down</title>
    <!--  (c) 2017 CA Technologies.  All Rights Reserved. -->
    <!--  Build Date: Tue Jan 23 2018 13:04:56 GMT-0700 (MST) -->
    
    <script type="text/javascript">
        var APP_BUILD_DATE = "Tue Jan 23 2018 13:04:56 GMT-0700 (MST)";
        var STORY    = "";
        var BUILDER  = "johty01";
        var CHECKSUM = 29742534912;
    </script>
    
    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>
    <!-- our highcharts (needed so that we can add patterns) 
    <script type="text/javascript" src="/apps/2.1/lib/analytics/analytics-all.js"></script>
    -->
    
    
    <script type="text/javascript">
        Rally.onReady(function() {
            (window.Ext4||window.Ext).define("SettingsUtils",{alias:"tssettingsutils",statics:{SETTING_NAME_SCOPE:"portfolioItemScope",SETTING_NAME_RELEASE:"release",SETTING_NAME_PORTFOLIO_ITEMS:"portfolioItems",SCOPE_INDIVIDUAL_PORTFOLIO_ITEMS:"individual",SCOPE_RELEASE_PORTFOLIO_ITEMS:"release"},localSettings:void 0,constructor:function(){this.localSettings=Rally.getApp().getSettings()},getSetting:function(t){return this.localSettings[t]},createPortfolioItemsSettings:function(t){var e=t.map(function(t){return{_ref:t._ref,FormattedID:t.FormattedID,oid:Rally.util.Ref.getOidFromRef(t._ref),PlannedStartDate:t.PlannedStartDate,ActualStartDate:t.ActualStartDate,PlannedEndDate:t.PlannedEndDate}});return this.localSettings[SettingsUtils.SETTING_NAME_SCOPE]=SettingsUtils.SCOPE_INDIVIDUAL_PORTFOLIO_ITEMS,this.localSettings[SettingsUtils.SETTING_NAME_PORTFOLIO_ITEMS]=JSON.stringify(e),this.localSettings},createReleaseSettings:function(t){var e={};return t&&(e={_ref:t.get("_ref"),ObjectID:Rally.util.Ref.getOidFromRef(t.get("_ref")),Name:t.get("Name"),ReleaseStartDate:t.get("ReleaseStartDate"),ReleaseDate:t.get("ReleaseDate")}),this.localSettings[SettingsUtils.SETTING_NAME_SCOPE]=SettingsUtils.SCOPE_RELEASE_PORTFOLIO_ITEMS,this.localSettings[SettingsUtils.SETTING_NAME_RELEASE]=JSON.stringify(e),this.localSettings},getPortfolioItems:function(){var t,e=this.getSetting(SettingsUtils.SETTING_NAME_PORTFOLIO_ITEMS)||"[]";try{t=JSON.parse(e)}catch(e){t=[]}return t},getRelease:function(){var t,e=this.getSetting(SettingsUtils.SETTING_NAME_RELEASE)||"{}";try{t=JSON.parse(e)}catch(t){}return t},getScope:function(){return this.getSetting(SettingsUtils.SETTING_NAME_SCOPE)},isReleaseScope:function(){return this.getSetting(SettingsUtils.SETTING_NAME_SCOPE)===SettingsUtils.SCOPE_RELEASE_PORTFOLIO_ITEMS}}),function(){var t=window.Ext4||window.Ext,e="RELEASE_PICKER_ITEMID",i="Select Release",a="Select Individual Portfolio Items";t.define("com.ca.technicalservices.Burnupdown.PortfolioItemPicker",{extend:"Ext.form.FieldContainer",alias:"widget.chartportfolioitempicker",requestContext:void 0,requires:["Deft.Deferred","Rally.util.Test","Rally.ui.EmptyTextFactory","Rally.ui.dialog.ChooserDialog","Rally.data.wsapi.Store","SettingsUtils"],mixins:["Ext.form.field.Field"],config:{settingsUtils:{}},emptyText:"<p>No portfolio items match your search criteria.</p>",portfolioItemScope:SettingsUtils.SCOPE_RELEASE_PORTFOLIO_ITEMS,portfolioItemsAttributes:["ObjectID","Project","WorkSpace","FormattedID","Name","ActualStartDate","PlannedStartDate","ActualEndDate","PlannedEndDate"],portfolioItems:[],release:void 0,items:[{xtype:"radiogroup",title:"Scope",itemId:"scopeRadioGroup",items:[{boxLabel:i,name:SettingsUtils.SETTING_NAME_SCOPE,inputValue:SettingsUtils.SCOPE_RELEASE_PORTFOLIO_ITEMS,checked:!0},{boxLabel:a,name:SettingsUtils.SETTING_NAME_SCOPE,inputValue:SettingsUtils.SCOPE_INDIVIDUAL_PORTFOLIO_ITEMS}]},{xtype:"fieldset",itemId:SettingsUtils.SCOPE_RELEASE_PORTFOLIO_ITEMS,title:i,items:[{xtype:"rallyreleasecombobox",itemId:e,name:SettingsUtils.SETTING_NAME_RELEASE,submitValue:!1}]},{xtype:"fieldset",itemId:SettingsUtils.SCOPE_INDIVIDUAL_PORTFOLIO_ITEMS,title:a,hidden:!0,items:[{xtype:"label",text:"Portfolio Item"},{xtype:"container",name:"portfolioItemPicker",layout:{type:"hbox"},items:[{xtype:"rallybutton",text:"Add",itemId:"portfolioItemButton"},{xtype:"container",cls:"piDisplayField",items:[{xtype:"container",itemId:"portfolioItemDisplay",value:"&nbsp;"}]}]}]}],constructor:function(t){return this.initConfig(t),this.callParent(arguments),this},beforeRender:function(){this._configureRadio(),this._configureReleasePicker(),this._configureButton(),this._configurePicker()},_configureRadio:function(){var t={};t[SettingsUtils.SETTING_NAME_SCOPE]=this.config.settingsUtils.getScope();var e=this.down("#scopeRadioGroup");e.on({scope:this,change:function(t,e){this._onScopeChange(e[SettingsUtils.SETTING_NAME_SCOPE])}}),e.setValue(t)},_configureReleasePicker:function(){var t=this.down("#"+e);t.setValue(this.config.settingsUtils.getRelease()._ref),t.on("change",function(t){this._onReleaseChange(t.getRecord())},this)},_onReleaseChange:function(t){this.release=t},_configureButton:function(){this.down("#portfolioItemButton").on("click",this._onButtonClick,this)},_configurePicker:function(){this._setupRequestContext(),this._createPortfolioItemStore()},_setupRequestContext:function(){this.requestContext={workspace:Rally.getApp().context.getWorkspaceRef(),project:null}},_createPortfolioItemStore:function(){var e=this.config.settingsUtils.getPortfolioItems();if(e.length>0){var i=Rally.data.wsapi.Filter.or(t.Array.map(e,function(t){return{property:"ObjectID",operator:"=",value:Rally.util.Ref.getOidFromRef(t._ref)}}));t.create("Rally.data.wsapi.Store",{model:t.identityFn("Portfolio Item"),filters:i,context:this.requestContext,fetch:this.portfolioItemsAttributes,autoLoad:!0,listeners:{load:this._onPortfolioItemsRetrieved,scope:this}})}},_onPortfolioItemsRetrieved:function(e,i){var a=i;t.isArray(a)||(a=[i]),this._handleStoreResults(a)},_setDisplayValue:function(){var t=this.down("#portfolioItemDisplay");t.removeAll(),t.add(this._getPortfolioItemDisplay())},_onButtonClick:function(){this._destroyChooser(),this.dialog=t.create("Rally.ui.dialog.ArtifactChooserDialog",this._getChooserConfig()),this.dialog.show()},_destroyChooser:function(){this.dialog&&this.dialog.destroy()},_getPortfolioItemDisplay:function(){if(!t.isEmpty(this.portfolioItems))return t.Array.map(this.portfolioItems,function(t){return{xtype:"button",cls:"project-button",text:t.FormattedID+" <span class='icon-delete'></span>",listeners:{scope:this,click:function(){this._removeItem(t)}}}},this)},_removeItem:function(e){this.portfolioItems=t.Array.filter(this.portfolioItems,function(t){return e.FormattedID!=t.FormattedID}),this._setDisplayValue()},_onPortfolioItemChosen:function(e,i){var a=t.Array.merge(i,this.portfolioItems);this._handleStoreResults(a),this._destroyChooser()},_handleStoreResults:function(e){var i=t.Array.map(e,function(e){return t.isFunction(e.getData)?e.getData():e});this.portfolioItems=_.unique(i,"_ref"),this._setDisplayValue()},_getChooserConfig:function(){return{artifactTypes:["portfolioitem"],multiple:!0,height:350,title:"Choose Portfolio Item(s) to Add",closeAction:"destroy",selectionButtonText:"Select",_isArtifactEditable:function(t){return!0},listeners:{artifactChosen:this._onPortfolioItemChosen,scope:this},storeConfig:{project:null,context:this.requestContext,fetch:this.portfolioItemsAttributes},gridConfig:{viewConfig:{emptyText:Rally.ui.EmptyTextFactory.getEmptyTextFor(this.emptyText),getRowClass:function(t){return Rally.util.Test.toBrowserTestCssClass("row",t.getId())+""}}}}},getSubmitData:function(){var t={};switch(this.portfolioItemScope){case SettingsUtils.SCOPE_RELEASE_PORTFOLIO_ITEMS:t=this.config.settingsUtils.createReleaseSettings(this.release);break;case SettingsUtils.SCOPE_INDIVIDUAL_PORTFOLIO_ITEMS:default:t=this.config.settingsUtils.createPortfolioItemsSettings(this.portfolioItems)}return t},_onScopeChange:function(t){this.portfolioItemScope=t;var e=this.down("#"+SettingsUtils.SCOPE_INDIVIDUAL_PORTFOLIO_ITEMS),i=this.down("#"+SettingsUtils.SCOPE_RELEASE_PORTFOLIO_ITEMS);t===SettingsUtils.SCOPE_RELEASE_PORTFOLIO_ITEMS?(e.setDisabled(!0).setVisible(!1),i.setDisabled(!1).setVisible(!0)):(e.setDisabled(!1).setVisible(!0),i.setDisabled(!0).setVisible(!1))}})}(),function(){var t=window.Ext4||window.Ext;t.define("com.ca.technicalservices.Burnupdown.StoriesManager",function(){return{config:{storiesFields:["ObjectID","Iteration","Project"]},constructor:function(t){return this.initConfig(t),this},getCurrentStories:function(e){var i=t.create("Deft.Deferred"),a=_.map(e,function(t){return t.get("ObjectID")}),n=Rally.getApp().getContext().getDataContext(),r=[{property:"_TypeHierarchy",value:"HierarchicalRequirement"},{property:"Children",value:null},{property:"__At",value:"current"},{property:"_ItemHierarchy",operator:"in",value:a},{property:"_ProjectHierarchy",value:Rally.util.Ref.getOidFromRef(n.project)}];return t.create("Rally.data.lookback.SnapshotStore",{autoLoad:!0,fetch:this.getStoriesFields(),filters:r,limit:1/0,listeners:{load:function(t,e,a){!a||e.length<1?i.reject("Unable to load user stories for the selected features"):i.resolve(_.pluck(e,"raw"))}}}),i.getPromise()}}}())}(),function(){var t=window.Ext4||window.Ext;t.define("com.ca.technicalservices.Burnupdown.FeatureManager",function(){return{config:{settingsUtils:{},featureFields:["ObjectID","Name","c_InitialHourEstimate","PlannedStartDate","ActualStartDate","PlannedEndDate","FormattedID"]},constructor:function(t){return this.initConfig(t),this},getFeatures:function(e){return e?function(e){var i=t.create("Deft.Deferred");return e?t.create("Rally.data.wsapi.Store",{autoLoad:!0,model:"PortfolioItem/Feature",context:{projectScopeUp:!0},limit:1/0,fetch:this.getFeatureFields(),filters:[{property:"Release.Name",value:e.get("Name")}],listeners:{load:function(t,a,n){!n||a.length<1?i.reject('No features found in release "'+e.get("Name")+'" in the current or parent projects.'):i.resolve(a)}}}):i.reject("No release set"),i.getPromise()}.call(this,e):function(e){var i=t.create("Deft.Deferred"),a=_.map(e,function(t){return t.oid});if(a.length<1)i.reject("No portfolio items set");else{var n=[{property:"_TypeHierarchy",value:"PortfolioItem/Feature"},{property:"__At",value:"current"},{property:"_ItemHierarchy",operator:"in",value:a}];t.create("Rally.data.lookback.SnapshotStore",{autoLoad:!0,fetch:this.getFeatureFields(),limit:1/0,filters:n,listeners:{load:function(t,e,n){!n||e.length<1?i.reject("Unable to load feature IDs "+a):i.resolve(e)}}})}return i.getPromise()}.call(this,this.config.settingsUtils.getPortfolioItems())}}}())}(),function(){var t=window.Ext4||window.Ext;t.define("com.ca.technicalservices.Burnupdown.ReleaseManager",function(){return{config:{releaseFields:["ObjectID","Name","ReleaseStartDate","ReleaseDate"]},constructor:function(t){return this.initConfig(t),this},getReleaseByName:function(e){var i=t.create("Deft.Deferred");return e?t.create("Rally.data.wsapi.Store",{autoLoad:!0,model:"Release",context:{projectScopeUp:!1,projectScopeDown:!1},limit:1,fetch:this.getReleaseFields(),filters:[{property:"Name",value:e}],listeners:{load:function(t,a,n){!n||a.length<1?i.reject('Unable to load release "'+e+'" for the current project.'):i.resolve(a[0])}}}):i.reject("No release set"),i.getPromise()}}}())}(),function(){var t=window.Ext4||window.Ext;t.define("com.ca.technicalservices.Burnupdown.UserIterationCapacitiesManager",function(e){function i(e){var i=e.getGroups(),n=e.sum("Capacity",!0);_.each(i,function(e){var i=_.clone(e.children[0].data.Iteration);i.StartDate=t.Date.parse(i.StartDate,"c"),i.EndDate=t.Date.parse(i.EndDate,"c"),i.capacity=n[i._ref],i.dailyCapacity=Math.floor(i.capacity/function(e){if(!e.StartDate||!e.EndDate)return void t.MessageBox.alert("Invalid Iteration","Iteration "+e.Name+" missing StartDate or EndDate");var i=0,a=t.Date.parse(e.StartDate,"c"),n=t.Date.parse(e.EndDate,"c");for(;a<=n;){var r=t.Date.format(a,"l");_.contains(this.getWorkDays(),r)&&i++,a=t.Date.add(a,t.Date.DAY,1)}return i}.call(this,i)),a[i._ref]=i},this)}var a={},n=["Capacity","User","Iteration","StartDate","EndDate"];return{config:{workDays:["Monday","Tuesday","Wednesday","Thursday","Friday"]},constructor:function(t){return this.initConfig(t),this},loadCapacitiesForDates:function(e,a){var r=t.create("Deft.Deferred"),o=Rally.data.wsapi.Filter.and([{property:"Iteration.StartDate",operator:"<",value:a.toISOString()},{property:"Iteration.EndDate",operator:">",value:e.toISOString()}]);return t.create("Rally.data.wsapi.Store",{autoLoad:!0,model:"UserIterationCapacity",limit:1/0,context:{projectScopeDown:!0},fetch:n,groupField:"Iteration",getGroupString:function(t){return t.data.Iteration._ref},filters:o,listeners:{scope:this,load:function(t,n,o){o?(n.length<1&&console.warn("No user iteration capacities found"),i.call(this,t),r.resolve()):r.reject("Unable to load user iteration capacities for date range "+e+" to "+a)}}}),r.getPromise()},getCapacitiesForDateString:function(e){var i=t.Date.parse(e,"c"),n=_.filter(a,function(e){return t.Date.between(i,e.StartDate,e.EndDate)});return _.reduce(n,function(t,e){return t.total+=e.capacity,t.daily+=e.dailyCapacity,t},{total:0,daily:0})}}}())}(),(window.Ext4||window.Ext).define("com.ca.technicalservices.Burnupdown.DateRange",function(){function t(t,e){var i=e;return t&&(!e||t<e)&&(i=t),i}return{config:{earliestPlannedStartDate:void 0,earliestActualStartDate:void 0,latestPlannedEndDate:void 0},constructor:function(t){return this.initConfig(t),this},addDates:function(e,i,a){this.setEarliestPlannedStartDate(t(e,this.earliestPlannedStartDate)),this.setEarliestActualStartDate(t(i,this.earliestActualStartDate)),this.setLatestPlannedEndDate(function(t,e){var i=e;return t&&(!e||t>e)&&(i=t),i}(a,this.latestPlannedEndDate))},getStartDate:function(){var t=this.getEarliestActualStartDate();return t||(this.getEarliestPlannedStartDate()||new Date)},getEndDate:function(){return this.getLatestPlannedEndDate()||new Date}}}()),function(){var t=window.Ext4||window.Ext;t.define("com.ca.technicalservices.Burnupdown.DateManager",function(){return{config:{},require:["com.ca.technicalservices.Burnupdown.DateRange"],constructor:function(t){return this.initConfig(t),this},getDateRange:function(e,i){var a=function(e,i){return _.reduce(e,function(e,i){var a=i.get("PlannedStartDate")?t.Date.parse(i.get("PlannedStartDate"),"c"):void 0,n=i.get("ActualStartDate")?t.Date.parse(i.get("ActualStartDate"),"c"):void 0,r=i.get("PlannedEndDate")?t.Date.parse(i.get("PlannedEndDate"),"c"):void 0;return e.addDates(a,n,r),e},i)}(i,t.create("com.ca.technicalservices.Burnupdown.DateRange"));return e&&(a=function(e,i){var a=e.get("ReleaseStartDate")?t.Date.parse(e.get("ReleaseStartDate"),"c"):void 0,n=e.get("ReleaseDate")?t.Date.parse(e.get("ReleaseDate"),"c"):void 0;return i.addDates(a,void 0,n),i}(e,a)),a}}}())}(),function(){var t=window.Ext4||window.Ext,e="To Do ",i="Total To Do",a="Actual ",n="Capacity Based Burndown",r="Future "+n,o="Refined Estimate",s="Actual Start Index",l="Preliminary Estimate",c=i+" Max";t.define("com.ca.technicalservices.Burnupdown.Calculator",{extend:"Rally.data.lookback.calculator.TimeSeriesCalculator",config:{iterationCapacitiesManager:void 0,updateProjectedDoneDateCallback:void 0},remainingIdealTodo:void 0,metricsAllowedOnFutureDates:["Total Capacity","Daily Capacity",n,r,o,"Ideal",l],features:void 0,constructor:function(t){this.initConfig(t),this.callParent(arguments)},runCalculation:function(i){var n=this.callParent(arguments);n=this._nullFutureData(n),this.config.updateProjectedDoneDateCallback&&this.config.updateProjectedDoneDateCallback(this.currentCapacity,this.currentTodo);var r={},o=0,s=["rgb(214,234,194)","rgb(167,217,197)","rgb(121,199,199)","rgb(77,183,204)","rgb(47,161,199)","rgb(41,134,181)","rgb(37,108,164)","rgb(33,83,147)","rgb(27,58,130)","rgb(22,36,115)","rgb(19,28,90)","rgb(17,21,66)"],l=s.length,c=Math.min(1,Math.floor(l/Math.min(l,this.features.length)));return _.each(this.features,function(i){r[e+i.get("FormattedID")]={stack:e,color:t.draw.Color.toHex(s[o]),borderRadius:10},r[a+i.get("FormattedID")]={stack:a,color:t.draw.Color.toHex(s[o])},o=(o+c)%l}),n.series=_.map(n.series,function(t){return _.merge(t,r[t.name])}),n},_nullFutureData:function(t){return this.todayIndex>-1&&_.each(t.series,function(t){_.contains(this.metricsAllowedOnFutureDates,t.name)||(t.data=_.map(t.data,function(t,e){return e>this.todayIndex?null:t},this))},this),t},_getDailyCapacityForTick:function(t){return this.iterationCapacitiesManager.getCapacitiesForDateString(t.tick).daily},_getCapacityBurndownForTick:function(e,i,a,r){var o=0,l=a[s];if(i<l)o=null;else if(i==l)o=a[c];else{var u,d=a["Today Index"];if(-1==d){var f=new Date;d=t.Date.parse(r[0].tick,"c")>f?0:r.length-1}u=i>d?r[d]:e;var h=this._getDailyCapacityForTick(u),g=r[i-1];o=Math.max(0,g[n]-h)}return o},_getFutureCapacityBurndownForTick:function(t,e,a,n){var o=0;if(this.todayIndex<0)o=null;else if(e<this.todayIndex)o=null;else if(e==this.todayIndex)o=t[i],this.currentTodo=o;else{var s;s=n[this.todayIndex];var l=this._getDailyCapacityForTick(s);this.currentCapacity=l;var c=n[e-1];o=Math.max(0,c[r]-l)}return o},_getDataForFeature:function(t,e,i){return e.Feature===t.get("ObjectID")?e[i]:0},_getFeaturesInitialHourEstimates:function(){return _.reduce(this.features,function(t,e){return t+(e.get("c_InitialHourEstimate")||0)},0)},_getFeaturesInitialHourEstimatesMetric:function(t,e,i,a){return i[l]},_getIdealBurndownForTick:function(t,e,i,a){var n=0,r=i[s];if(e<r)n=null;else{if(e!=r){var o=i[c],l=o/(a.length-1-r);return Math.floor(100*(o-(e-r)*l))/100}n=i[c]}return n},getDerivedFieldsOnInput:function(){var t=this,i=[];return _.forEach(this.features,function(n){i.push({as:e+n.get("FormattedID"),f:function(e){return t._getDataForFeature(n,e,"TaskRemainingTotal")}}),i.push({as:a+n.get("FormattedID"),f:function(e){return t._getDataForFeature(n,e,"TaskActualTotal")}})},this),i},getMetrics:function(){var t=[];return _.each(this.features,function(i){t.push({field:e+i.get("FormattedID"),as:e+i.get("FormattedID"),f:"sum",display:"column"}),t.push({field:a+i.get("FormattedID"),as:a+i.get("FormattedID"),f:"sum",display:"column"})}),t.push({field:"TaskRemainingTotal",as:i,f:"sum"}),t.push({field:"TaskActualTotal",as:"Total Actual",f:"sum"}),t.push({field:"TaskEstimateTotal",as:o,f:"sum"}),t},getSummaryMetricsConfig:function(){return[{as:l,f:this._getFeaturesInitialHourEstimates.bind(this)},{field:o,as:c,f:"max"},{as:s,f:function(e,i){var a=t.Date.parse(this.getStartDate(),"c");return _.findIndex(e,function(e){return t.Date.parse(e.tick,"c")>=a})}.bind(this)},{as:"Today Index",f:function(e,i){return this.todayIndex=_.findIndex(e,function(e){return t.Date.parse(e.tick,"c")>new Date}),this.todayIndex}.bind(this)}]},getDerivedFieldsAfterSummary:function(){return[{as:n,f:this._getCapacityBurndownForTick.bind(this),display:"line"},{as:r,f:this._getFutureCapacityBurndownForTick.bind(this),display:"line"},{field:l,as:l,f:this._getFeaturesInitialHourEstimatesMetric.bind(this),display:"line"},{as:"Ideal",f:this._getIdealBurndownForTick.bind(this),display:"line"}]}})}(),Ext.define("Rally.technicalservices.InfoLink",{extend:"Rally.ui.dialog.Dialog",alias:"widget.tsinfolink",informationHtml:null,title:"Build Information",defaults:{padding:5,margin:5},closable:!0,draggable:!0,autoShow:!0,width:350,informationalConfig:null,items:[{xtype:"container",itemId:"information"}],initComponent:function(){Ext.id(this);this.title="<span class='icon-help'> </span>"+this.title,this.callParent(arguments)},_generateChecksum:function(t){var e,i=305419896;for(t=(t=(t=t.replace(/var CHECKSUM = .*;/,"")).replace(/var BUILDER  = .*;/,"")).replace(/\s/g,""),e=0;e<t.length;e++)i+=t.charCodeAt(e)*e;return i},_checkChecksum:function(t){var e=Ext.create("Deft.Deferred"),i=this;return Ext.Ajax.request({url:document.URL,params:{id:1},success:function(t){if(text=t.responseText,CHECKSUM){var a=i._generateChecksum(text);if(CHECKSUM!==a)return void e.resolve(!1)}e.resolve(!0)}}),e.promise},_addToContainer:function(t){var e=Ext.apply({xtype:"container",height:200,overflowY:!0},this.informationalConfig);t.add(e)},afterRender:function(){var t=Rally.getApp();if(!Ext.isEmpty(this.informationalConfig)){var e=this.down("#information");this._addToContainer(e)}t.isExternal()?this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:"... Running externally"}):this._checkChecksum(t).then({scope:this,success:function(t){t||this.addDocked({xtype:"container",cls:"build-info",dock:"bottom",padding:2,html:'<span class="icon-warning"> </span>Checksums do not match'})},failure:function(t){console.log("oops:",t)}}),this.callParent(arguments)},beforeRender:function(){if(this.callParent(arguments),this.informationHtml&&this.addDocked({xtype:"component",componentCls:"intro-panel",padding:2,html:this.informationHtml,doc:"top"}),this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:"This app was created by the CA AC Technical Services Team."}),APP_BUILD_DATE){var t=Ext.String.format("Built on: {0} <br/>Built by: {1}",APP_BUILD_DATE,BUILDER);STORY&&(t=t+"<br/>Source story: "+STORY),this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:t})}}}),Ext.define("Rally.technicalservices.Logger",{constructor:function(t){Ext.apply(this,t)},log:function(t){var e="[ "+Ext.util.Format.date(new Date,"Y-m-d H:i:s.u")+" ]",i=[];i=Ext.Array.push(i,[e]),i=Ext.Array.push(i,Ext.Array.slice(arguments,0)),window.console&&console.log.apply(console,i)}}),Ext.define("com.ca.technicalservices.Burnupdown",{extend:"Rally.app.App",componentCls:"app",settingsUtils:void 0,config:{defaultSettings:{portfolioItemPicker:""}},layout:{type:"vbox",align:"stretch"},items:[{xtype:"container",itemId:"chartArea",layout:"fit",flex:4},{xtype:"container",itemId:"detailsArea",height:200,layout:{type:"hbox",align:"stretch"},items:[{xtype:"form",title:"Metrics",flex:1,layout:{type:"vbox",align:"left"},border:!1,items:[{xtype:"component",itemId:"projectedDays"}]},{xtype:"container",width:30},{xtype:"container",itemId:"controlsArea",flex:1,layout:{type:"vbox",align:"stretch"}}]}],hierarchicalRequirementFields:["Name","TaskEstimateTotal","TaskActualTotal","TaskRemainingTotal","Feature"],getSettingsFields:function(){return[{xtype:"chartportfolioitempicker",settingsUtils:this.settingsUtils,height:350}]},addControls:function(){var t=Ext.create("com.ca.technicalservices.Burnupdown.PortfolioItemPicker",{settingsUtils:this.settingsUtils}),e=Ext.create("Ext.form.Panel",{xtype:"form",title:"Override Default Chart Settings",items:[t],border:!1,buttons:[{text:"Update",scope:this,handler:function(){t.getSubmitData(),this.down("#controlsArea").removeAll(),this.down("#chartArea").removeAll(),this.buildChart()}}]});this.down("#controlsArea").add(e)},launch:function(){this.settingsUtils=Ext.create("SettingsUtils"),this.buildChart()},buildChart:function(){var t,e,i,a,n,r,o;this.setLoading("Loading data ...");var s=Ext.create("com.ca.technicalservices.Burnupdown.ReleaseManager");t=this.settingsUtils.isReleaseScope()?s.getReleaseByName(this.settingsUtils.getRelease().Name):Deft.promise.Promise.when(void 0),this.addControls(),t.then({scope:this,success:function(t){e=t;return Ext.create("com.ca.technicalservices.Burnupdown.FeatureManager",{settingsUtils:this.settingsUtils}).getFeatures(e)}}).then({scope:this,success:function(t){i=t;var a=Ext.create("com.ca.technicalservices.Burnupdown.DateManager").getDateRange(e,i);n=a.getStartDate(),r=a.getEndDate();return Ext.create("com.ca.technicalservices.Burnupdown.StoriesManager").getCurrentStories(i)}}).then({scope:this,success:function(t){return a=t,(o=Ext.create("com.ca.technicalservices.Burnupdown.UserIterationCapacitiesManager")).loadCapacitiesForDates(n,r)}}).then({scope:this,success:function(){var t=_.pluck(a,"ObjectID");this.down("#chartArea").add({xtype:"rallychart",storeType:"Rally.data.lookback.SnapshotStore",storeConfig:this._getStoreConfig(t),calculatorType:"com.ca.technicalservices.Burnupdown.Calculator",calculatorConfig:{granularity:"hour",startDate:n,endDate:r,iterationCapacitiesManager:o,features:i,updateProjectedDoneDateCallback:this._updateProjectedDoneDate.bind(this)},chartConfig:this._getChartConfig(this._getChartTitle(e,i)),loadMask:!1,listeners:{scope:this,readyToRender:function(){this.setLoading(!1)}}}).setLoadMask(!1)}}).otherwise({scope:this,fn:function(t){this.setLoading(!1),Ext.Msg.alert("Error",t)}})},_getStoreConfig:function(t){return{findConfig:{_TypeHierarchy:{$in:["HierarchicalRequirement"]},Children:null,ObjectID:{$in:t},_ValidFrom:{$lt:Rally.util.DateTime.toIsoString(new Date)}},fetch:this.hierarchicalRequirementFields,sort:{_ValidFrom:1},context:this.getContext().getDataContext(),limit:1/0}},_getChartConfig:function(t){return{chart:{zoomType:"xy"},title:{text:t},xAxis:{tickmarkPlacement:"on",tickInterval:30,title:{text:"Date"}},yAxis:[{title:{text:"Hours"}}],plotOptions:{series:{marker:{enabled:!1}},column:{stacking:"normal"}}}},_getChartTitle:function(t,e){return this.settingsUtils.isReleaseScope()?"Release: "+t.get("Name"):"Features: "+_.map(e,function(t){return t.get("FormattedID")}).join(", ")},_updateProjectedDoneDate:function(t,e){var i="Unknown";0==e?i="None":t>0&&(i=Math.ceil(e/t)),this.down("#projectedDays").update("Projected Work Days Until Done: "+i)}});
            
               Rally.launchApp('com.ca.technicalservices.Burnupdown', {
                   name: 'Portfolio Task Burn Up/Down'
               });
        });
    </script>
    
    <style type="text/css">

.app {
}
.tsinfolink {
    position:absolute;
    right:0px;
    width: 14px;
    height: 14px;
    border-radius: 7px;
    text-align: center;
    color: white;
    background: #C0C0C0;
    border-style: solid;
    border-width: 1px;
    margin-top: 25px;
    margin-right: 5px;
    cursor: pointer;
}
    </style>

</head>
<body></body>
</html>